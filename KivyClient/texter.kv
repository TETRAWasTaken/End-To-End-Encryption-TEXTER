#:kivy 2.1.0
#:import Hex kivy.utils.get_color_from_hex

# --- Color Constants ---
#:set BG_DARK Hex('#1e1e1e')
#:set BG_PANEL Hex('#252526')
#:set BG_INPUT Hex('#333333')
#:set ACCENT_BLUE Hex('#007acc')
#:set ACCENT_GREEN Hex('#4ec9b0')
#:set ACCENT_RED Hex('#f44747')
#:set TEXT_WHITE Hex('#ffffff')
#:set TEXT_GREY Hex('#999999')

# --- Styles ---

<FlatButton@Button>:
    background_normal: ''
    background_down: ''
    background_color: ACCENT_BLUE
    color: TEXT_WHITE
    font_size: '14sp'
    bold: True
    canvas.before:
        Color:
            rgba: (0,0,0,0.1) if self.state == 'normal' else (0,0,0,0.3)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [4]

<SidebarTab@ToggleButton>:
    background_normal: ''
    background_down: ''
    background_color: BG_PANEL if self.state == 'normal' else ACCENT_BLUE
    group: 'sidebar'
    allow_no_selection: False
    font_size: '13sp'
    bold: True
    color: TEXT_WHITE

<RoundedInput@TextInput>:
    background_normal: ''
    background_active: ''
    background_color: BG_INPUT
    foreground_color: TEXT_WHITE
    cursor_color: ACCENT_BLUE
    padding: [10, (self.height - self.line_height) / 2]
    multiline: False
    font_size: '14sp'
    write_tab: False
    canvas.after:
        Color:
            rgba: (1,1,1,0.1)
        Line:
            width: 1
            rounded_rectangle: (self.x, self.y, self.width, self.height, 4)

# --- Python-Linked Classes ---
# These now link to the classes in main.py, ensuring events work

<ContactButton>:
    # No dynamic "on_release" needed here, handled in Python class
    canvas.before:
        Color:
            rgba: (1,1,1,0.05) if self.state == 'normal' else ACCENT_BLUE
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [4]
    padding: dp(10)
    Label:
        text: root.text
        text_size: self.size
        halign: 'left'
        valign: 'middle'
        shorten: True
        shorten_from: 'right'
        color: TEXT_WHITE

<RequestBox>:
    canvas.before:
        Color:
            rgba: (1,1,1,0.05)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [4]
    padding: dp(5)
    spacing: dp(5)
    Label:
        text: root.username
        color: TEXT_WHITE
        text_size: self.size
        halign: 'left'
        valign: 'middle'
        shorten: True
    FlatButton:
        text: 'Accept'
        size_hint_x: None
        width: dp(60)
        font_size: '11sp'
        background_color: ACCENT_GREEN
        on_release: app.controller.accept_friend_request(root.username)

# --- Screens ---

<LoginScreen>:
    name: 'login'
    canvas.before:
        Color:
            rgba: BG_DARK
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout:
        orientation: 'vertical'
        size_hint: None, None
        size: dp(320), dp(420)
        pos_hint: {'center_x': 0.5, 'center_y': 0.5}
        padding: dp(20)
        spacing: dp(15)

        canvas.before:
            Color:
                rgba: BG_PANEL
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [8]

        Label:
            text: "TEXTER"
            font_size: '28sp'
            bold: True
            color: ACCENT_GREEN
            size_hint_y: 0.2

        Label:
            text: "Secure Encrypted Messenger"
            font_size: '13sp'
            color: TEXT_GREY
            size_hint_y: 0.1

        Widget:
            size_hint_y: 0.1

        RoundedInput:
            id: user_input
            hint_text: "Username"
            size_hint_y: None
            height: dp(40)

        RoundedInput:
            id: pass_input
            hint_text: "Password"
            password: True
            size_hint_y: None
            height: dp(40)

        Widget:
            size_hint_y: 0.1

        BoxLayout:
            size_hint_y: None
            height: dp(40)
            spacing: dp(10)

            FlatButton:
                id: login_btn
                text: "Login"
                on_release: app.controller.handle_login_request(user_input.text, pass_input.text)

            FlatButton:
                id: register_btn
                text: "Register"
                background_color: BG_INPUT
                on_release: app.controller.handle_register_request(user_input.text, pass_input.text)

        Label:
            id: status_label
            text: "Ready to connect"
            font_size: '11sp'
            color: TEXT_GREY
            size_hint_y: 0.15

<ChatScreen>:
    name: 'chat'
    canvas.before:
        Color:
            rgba: BG_DARK
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout:
        orientation: 'horizontal'
        padding: dp(10)
        spacing: dp(10)

        # --- Sidebar ---
        BoxLayout:
            orientation: 'vertical'
            size_hint_x: None
            width: dp(260)
            canvas.before:
                Color:
                    rgba: BG_PANEL
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [6]
            padding: dp(8)
            spacing: dp(8)

            # Sidebar Tabs
            BoxLayout:
                size_hint_y: None
                height: dp(35)
                spacing: dp(5)
                SidebarTab:
                    text: 'Contacts'
                    state: 'down'
                    on_release: sidebar_sm.transition.direction = 'right'; sidebar_sm.current = 'contacts_pg'
                SidebarTab:
                    text: 'Requests'
                    on_release: sidebar_sm.transition.direction = 'left'; sidebar_sm.current = 'requests_pg'

            # Sidebar Content
            ScreenManager:
                id: sidebar_sm

                Screen:
                    name: 'contacts_pg'
                    BoxLayout:
                        orientation: 'vertical'
                        spacing: dp(10)

                        BoxLayout:
                            size_hint_y: None
                            height: dp(40)
                            spacing: dp(5)
                            RoundedInput:
                                id: partner_input
                                hint_text: 'Username'
                            FlatButton:
                                text: '+'
                                size_hint_x: None
                                width: dp(40)
                                background_color: ACCENT_GREEN
                                on_release: app.add_contact(partner_input.text)

                        RecycleView:
                            id: contact_list
                            viewclass: 'ContactButton'
                            scroll_type: ['bars', 'content']
                            bar_width: dp(8)
                            RecycleBoxLayout:
                                default_size: None, dp(48)
                                default_size_hint: 1, None
                                size_hint_y: None
                                height: self.minimum_height
                                orientation: 'vertical'
                                spacing: dp(2)

                Screen:
                    name: 'requests_pg'
                    BoxLayout:
                        orientation: 'vertical'
                        spacing: dp(10)

                        BoxLayout:
                            size_hint_y: None
                            height: dp(40)
                            spacing: dp(5)
                            RoundedInput:
                                id: friend_req_input
                                hint_text: 'Send Request'
                            FlatButton:
                                text: 'Send'
                                size_hint_x: None
                                width: dp(50)
                                on_release: app.controller.send_friend_request(friend_req_input.text)

                        RecycleView:
                            id: request_list
                            viewclass: 'RequestBox'
                            scroll_type: ['bars', 'content']
                            bar_width: dp(8)
                            RecycleBoxLayout:
                                default_size: None, dp(48)
                                default_size_hint: 1, None
                                size_hint_y: None
                                height: self.minimum_height
                                orientation: 'vertical'
                                spacing: dp(2)

            FlatButton:
                text: "Logout"
                size_hint_y: None
                height: dp(35)
                background_color: ACCENT_RED
                on_release: app.controller.logout()

        # --- Chat Area ---
        BoxLayout:
            orientation: 'vertical'
            canvas.before:
                Color:
                    rgba: BG_PANEL
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [6]

            # Header
            Label:
                id: chat_header
                text: "Select a contact"
                size_hint_y: None
                height: dp(50)
                font_size: '15sp'
                bold: True
                color: TEXT_WHITE
                canvas.before:
                    Color:
                        rgba: (0,0,0,0.15)
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [6, 6, 0, 0]

            # Messages
            ScrollView:
                id: chat_scroll
                do_scroll_x: False
                bar_width: dp(10)
                scroll_type: ['bars', 'content']

                BoxLayout:
                    id: chat_history
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height
                    padding: dp(15)
                    spacing: dp(12)

            # Input
            BoxLayout:
                size_hint_y: None
                height: dp(60)
                padding: dp(10)
                spacing: dp(10)
                canvas.before:
                    Color:
                        rgba: BG_DARK
                    Rectangle:
                        pos: self.pos
                        size: self.size

                RoundedInput:
                    id: message_input
                    hint_text: "Type a message..."
                    on_text_validate: app.send_message()

                FlatButton:
                    text: "Send"
                    size_hint_x: None
                    width: dp(70)
                    on_release: app.send_message()

<MessageLabel>:
    size_hint_y: None
    height: self.texture_size[1] + dp(16)
    size_hint_x: 0.85
    pos_hint: {'right': 1} if self.is_me else {'x': 0}

    text_size: self.width - dp(24), None
    halign: 'left'
    valign: 'middle'
    color: TEXT_WHITE
    padding: [12, 8]

    canvas.before:
        Color:
            rgba: ACCENT_BLUE if self.is_me else (1,1,1,0.1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [12, 12, 0, 12] if self.is_me else [12, 12, 12, 0]